---
title: "Genex Analysis"
author: "Teresa Gao"
date: "4 May 2020"
output: rmarkdown::github_document
---

# Setup

Load required libraries
```{r Load libraries}

library("dplyr")
library(tidyverse)
library("ggplot2")
library("gridExtra")
library("tidyboot")
```

Go to Session > Set Working Directory > To Source File Location. This ensures that we can find and access the files we need!

The code below imports the experimental data, as extracted by data_extraction.R

```{r Import data (CSVs)}

catch_trials_data <- read.csv("catch_trials_data.csv")
combined_trials_data <- read.csv("combined_trials_data.csv")
subject_info_data <- read.csv("subject_info_data.csv")

```

# Calculations
```{r Compute boostrapped confidence intervals}

CIs <- combined_trials_data %>%
  group_by(item_presentation_condition, n_examples) %>%
  tidyboot_mean(column = slider_response)

```

# Visualization

```{r Rename facet labels}

# This is used on facet_grid plots

n_examples_labels <- c("n_examples: 1", "n_examples: 2", "n_examples:3")
names(n_examples_labels) <- c("1", "2", "3")

trial_num_labels <- c("trial_num: 1", "trial_num: 2", "trial_num: 3")
names(trial_num_labels) <- c("1", "2", "3")

```

Box plot of slider response vs. number of examples

```{r Slider response vs. num. examples}

ggplot(data = combined_trials_data, 
       aes(x=slider_response, y=n_examples, 
           group=n_examples, fill=as.factor(n_examples))) +
  geom_boxplot() + 
  labs(
    title="Slider response vs. number of examples", 
    x="Slider response", 
    y="Number of examples"
    ) + 
  scale_fill_manual(values=c("indianred1", "lightgoldenrod1", "darkolivegreen2", "cornflowerblue")) +
  theme(legend.position="none")

```

Histogram and box plot of average time per slider response for each subject

```{r Average time per slider response}

# Initialize empty data frame for subject average time per trial
subject_average_time <- data.frame()

## forloop can be replaced with this:
combined_trials_data %>%
  group_by(worker_id) %>%
  summarize(ave_time_slider_response = mean(slider_time_in_seconds))

# Combine every three rows of trials_data, as there are three trials per participant
for(i in 1:nrow(combined_trials_data)) {
  three_row_sum <- 0
  
  # Add next term to sum of three rows
  three_row_sum <- three_row_sum + combined_trials_data[i, "slider_time_in_seconds"]
  three_row_average <- three_row_sum / 3
  
  # If this is the last of the grouping of three rows, add to subject_average_time data frame
  if((i %% 3) == 0) {
    subject_average_time <- rbind(subject_average_time, data.frame(three_row_average, combined_trials_data[i, "n_examples"]))
    three_row_sum <- 0
  }
}

# Rename columns (to make a human-readable histogram)
names(subject_average_time)[1] <- "time_in_seconds"
names(subject_average_time)[2] <- "n_examples"

# Create histogram
histogram <- ggplot(subject_average_time, aes(x=time_in_seconds)) + geom_histogram(fill="cornflowerblue", color="black", bins=24) + labs(title="Average time per slider response", x="Average time (sec)", y="Count")

box_plot <- ggplot(data=subject_average_time, aes(x=time_in_seconds, group=n_examples, fill=as.factor(n_examples))) + geom_boxplot() + labs(title="Average time per slider response", x="Average time (sec)", y="Number of examples") + scale_fill_manual(values=c("indianred1", "lightgoldenrod1", "darkolivegreen2", "cornflowerblue")) + theme(legend.position="none")

grid.arrange(histogram, box_plot, ncol=2)

```

Box plot of total trial time per participant vs. number of examples displayed

```{r Total trial time vs. num. examples}

ggplot(data=combined_trials_data, aes(x=trial_time_in_seconds, y=n_examples, group=n_examples, fill=as.factor(n_examples))) + geom_boxplot() + labs(title="Total trial time vs. number of examples", x="Total trial time (sec)", y="Number of examples") + scale_fill_manual(values=c("indianred1", "lightgoldenrod1", "darkolivegreen2", "cornflowerblue")) + theme(legend.position="none")

```

Facet grid of slider response plotted on number of examples vs. item presentation condition

```{r Slider response on num. examples vs. condition}

ggplot(combined_trials_data, aes(x=slider_response, y=(..count..)/tapply(..count..,..PANEL..,sum)[..PANEL..], fill=as.factor(item_presentation_condition))) + geom_histogram(color="black", bins=16) + labs(x="Slider response", y="Fraction of total count") + facet_grid(n_examples ~ item_presentation_condition, labeller=label_both) + scale_fill_manual(values=c("indianred1", "lightgoldenrod1", "darkolivegreen2", "cornflowerblue")) + theme(legend.position="none")

```

Observations:
- Accidental weaker than pedagogical
- Accidental has many responses < 0.5


Facet grid of slider response plotted on trial number vs. item presentation condition

```{r slider response on trial number vs. condition}
ggplot(combined_trials_data, aes(x=slider_response, y=(..count..)/tapply(..count..,..PANEL..,sum)[..PANEL..], fill=as.factor(item_presentation_condition))) + geom_histogram(color="black", bins=16) + labs(x="Slider response", y="Fraction of total count") + facet_grid(trial_num ~ item_presentation_condition, labeller=label_both) + scale_fill_manual(values=c("indianred1", "lightgoldenrod1", "darkolivegreen2", "cornflowerblue")) + theme(legend.position="none")
```

Observations:
- In pedagogical: perhaps there are weaker inferences on trials 2 & 3.
- In accidental: looks like, trial 1 - strong, trial 2 - weak, trial 3 - strong.



Facet grid of slider response plotted on number of examples vs. item presentation condition and item property

```{r Slider response on num examples vs. condition and property}

combined_trials_data %>%
  mutate(item_presentation_condition =
           factor(item_presentation_condition, 
                  levels = c("pedagogical", "accidental"),
                  labels = c("Pedagogical", "Accidental"))) %>%
 ggplot(., 
       aes(x=slider_response, y=(..count..)/tapply(..count..,..PANEL..,sum)[..PANEL..], fill=as.factor(item_presentation_condition))) +
  geom_histogram(color="black", bins=16) + 
  labs(x="Slider response", y="Fraction of total count") + 
  facet_grid(
    property+ n_examples ~ item_presentation_condition) +
  scale_fill_manual(values=c("indianred1", "lightgoldenrod1", "darkolivegreen2", "cornflowerblue")) + theme(legend.position="none")

```

Facet grid of slider resopnse plotted on speaker vs. item presentation condition

```{r Slider response on speaker vs. condition}

ggplot(combined_trials_data, aes(x=slider_response, y=(..count..)/tapply(..count..,..PANEL..,sum)[..PANEL..], fill=as.factor(item_presentation_condition))) + geom_histogram(color="black", bins=16) + labs(x="Slider response", y="Fraction of total count") + facet_grid(speaker ~ item_presentation_condition, labeller=label_both) + scale_fill_manual(values=c("indianred1", "lightgoldenrod1", "darkolivegreen2", "cornflowerblue")) + theme(legend.position="none")

```

Line range of slider response means and confidence intervals grouped by item presentation condition

```{r Slider response means and CIs vs. condition}

ggplot() + geom_linerange(data=CIs, mapping=aes(x=item_presentation_condition, ymin=ci_lower, ymax=ci_upper, color=as.factor(item_presentation_condition)), size=1) + geom_point(data=CIs, mapping=aes(x=item_presentation_condition, y=mean), alpha=0.5, size=2) + scale_color_manual(values=c("indianred1", "lightgoldenrod1", "darkolivegreen2", "cornflowerblue")) + labs(y="Slider response", x="Item presentation condition") + theme(legend.position="none")

```

Line range of slider response means and confidence intervals grouped by number of examples

```{r Slider response means and CIs vs. num examples}

ggplot() + geom_linerange(data=CIs, mapping=aes(x=n_examples, ymin=ci_lower, ymax=ci_upper, color=as.factor(item_presentation_condition)), size=1) + geom_point(data=CIs, mapping=aes(x=n_examples, y=mean), alpha=0.5, size=2) + labs(y="Slider response", x="Number of examples", color="Item presentation condition") + scale_color_manual(values=c("indianred1", "lightgoldenrod1", "darkolivegreen2", "cornflowerblue")) + theme(legend.position="bottom")

```



```{r}
ggplot(combined_trials_data, 
       aes(x = slider_response, 
           y = item_presentation_condition, fill = ..x..)) +
  ggridges::geom_density_ridges_gradient(
    jittered_points = T, alpha = 0.8, scale = 0.95,
    position = ggridges::position_points_jitter(width = 0.01, height = 0),
    point_shape = '|', point_size = 2.5, point_alpha = 0.3,
    rel_min_height = 0.01, gradient_lwd = 1,
    stat = 'binline', bins = 25, draw_baseline = F
  ) +
  ggstance::geom_linerangeh(data = CIs,
    inherit.aes = F,
    aes(xmin = ci_lower, xmax = ci_upper, 
        y = as.numeric(item_presentation_condition)+0.8),
    size = 1.25, color = 'black')+
  # geom_vline(data = df.bs %>% filter(condition == "Generic"), 
  #            inherit.aes = F, linetype = 2, alpha = 0.4,
  #            aes(xintercept = ci_lower))+
  # geom_vline(data = df.bs %>% filter(condition == "Generic"), 
  #            inherit.aes = F, linetype = 2, alpha = 0.4,
  #            aes(xintercept = ci_upper))+
  geom_point(data = CIs,
    inherit.aes = F,
    aes(x = mean,
        y = as.numeric(item_presentation_condition)+0.8),
    size = 3, color = 'black', shape = 3)+
  scale_x_continuous(expand = c(0.01, 0), 
                     limits = c(0, 1.02), 
                     breaks = c(0, 0.25, 0.5, 0.75, 1)) +
  scale_y_discrete(expand = c(0.01, 0)) +
  viridis::scale_fill_viridis(name = "Implied Prevalence", option = "D",
                     breaks = c(0, 1)) +
  guides(fill = F)+
  theme(axis.title.y = element_blank(),
        axis.title.x = element_text(hjust = 0.5, vjust = 0))+
  labs(x = "Probability of Future Instance having Property")
```

